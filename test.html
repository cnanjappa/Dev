<style>
	.BlogArchive{background-color:rgb(207, 223, 234);}
	.BlogArchive .blog-filter{float:left;padding:0;margin:0;}
	.BlogArchive .blog-filter-additional{float:left;padding:0;margin:0;}
	.BlogArchive .filter-submit{float:left;padding:0 0 0 10px;margin:0; width:80px; }
	.BlogArchive .filter-submit input {border-bottom-style:none; border-bottom-color:#33cc33; filter:progid:DXImageTransform.Microsoft.Gradient(GradientType=0,StartColorStr='#006600',EndColorStr='#009933'); BORDER-RIGHT-STYLE: none; BORDER-TOP-COLOR: #33cc33; WIDTH: 100%; BORDER-TOP-STYLE: none; COLOR: #ffffff; BORDER-RIGHT-COLOR: #33cc33; BORDER-LEFT-STYLE: none; BORDER-LEFT-COLOR: #33cc33; CURSOR: pointer;background-color:#006600;}
	.BlogArchive .blog-list {clear:left; margin:0px; background-color:transparent;}
	.BlogArchive .blog-list .blog-container{margin:0; width:98%;}
	.BlogArchive .blog-list .blog-container .blog-body {}
	.BlogArchive .blog-list .blog-container .blog-body .blog-item-header {padding:15px 0 15px 0; color:rgb(5, 49, 77); }
	.BlogArchive .blog-list .blog-container .blog-body .blog-item {padding:15px 10px;background-color:rgb(5, 49, 77); margin-bottom:10px; display:block; }
	.BlogArchive .blog-list .blog-container .blog-body .blog-item:hover {background-color:rgb(50, 103, 135);}
	.BlogArchive .blog-list .blog-container .blog-body .blog-item .blog-author{color:#ffffff; text-decoration:none;}
	.BlogArchive .blog-list .blog-container .blog-body .blog-item a {color:#ffffff; text-decoration:none;}
	.BlogArchive .blog-list .blog-container .blog-body .blog-item a:visited {color:#ffffff;}
	.BlogArchive .blog-list .blog-container .blog-body .blog-item .blog-date-time {line-height:18px;margin:2px 0 0 0;color:#ffffff;}
</style>

<div class="BlogArchive">
	<h2>Blog Archive</h2><br/>
    <div class="blog-filter">
    
        Year: &nbsp;
        <select id="selYear">
        </select><br/><br/>

		Category: &nbsp;
        <select id="selCategory">
        	<option value="All">All</option>
        </select><br/><br/>
                
        Author: &nbsp;
        <select id="selAuthor">
        	<option value="All">All</option>
        </select><br/><br/>

        <input type="button" value="Filter" onclick="buttonClick();">

    </div>
    <br/>
    <div class="blog-list">
        <div class="blog-container">
            <div class="blog-body"></div>
        </div>
    </div>
</div>
<script type="text/javascript" language="javascript" src="https://fnma.sharepoint.com/sites/HomeSite-Blogs/SiteAssets/homesite/jquery-1.11.1.min.js"></script>
<script type="text/javascript">

    $(document).ready(function () {
    
    	//populate year dropdown with previous three years
        var myselect = document.getElementById("selYear");
        var startYear = new Date().getFullYear();
        for(count=3;count>0;count--, startYear --)
        {
            myselect.add(new Option(startYear, startYear), null);
        }    
        
        //populate Caterogy	with HomeSiteBlogCategory choice field options
		var categorySelect= document.getElementById("selCategory");	         
        $.ajax({
	        url: "https://fnma.sharepoint.com/sites/HomeSite-Blogs/_api/web/lists/getByTitle('Site Pages')/fields?$filter=EntityPropertyName eq 'HomeSiteBlogCategory'",
	        type: "GET",
	        headers: {
	            "accept": "application/json;odata=verbose",
	        },
	        success: function (data) {
	        	$.each(data.d.results[0].Choices.results,function(count,item){	
	            	categorySelect.add(new Option(item, item), null);
                })	        },
	        error: function (error) {
	            console.log(JSON.stringify(error));
	        }	
	    }); 

		//populate author dropdown with unique blog authors
		var endDate = new Date().getFullYear();
        var beginDate = endDate -2;
		beginDate = beginDate + "-01-01T00%3a00%3a00";
        endDate = endDate + "-12-31T23%3a59%3a59"; 		
        $.ajax({
            url: "https://fnma.sharepoint.com/sites/HomeSite-Blogs/_api/web/lists/getByTitle('Site%20Pages')/items?$select=HomeSiteBlogAuthor,HomeSiteBlogArticleDate&$filter=(HomeSiteBlogArticleDate ge datetime'" + beginDate + "') and (HomeSiteBlogArticleDate le datetime'" + endDate + "')",
            type: "GET",
            async:false,
            headers: {
                "accept": "application/json;odata=verbose",
            },
            success: function (data) {
            	var blogAuthors = [];
            	var auth = "";
            	if (data.d.results.length > 0)
            	{	                
	                $.each(data.d.results,function(count,item){	
	                	auth = item.HomeSiteBlogAuthor;
	                	if (auth != undefined){
	                		if(blogAuthors.indexOf(auth ) === -1) {
	                			blogAuthors.push(auth);						     
						    }
						}      	                		
	                })  
                }      
                
                //Get Authors from Classic environment
                $.ajax({
		            url: "https://fnma.sharepoint.com/sites/fmhomesite/execblog/_api/web/lists/getByTitle('Executive%20Blogs')/items?$select=Authors&$filter=(ArticleStartDate ge datetime'" + beginDate + "')and(ArticleStartDate le datetime'" + endDate + "')",
		            type: "GET",
		            headers: {
		                "accept": "application/json;odata=verbose",
		            },
		            success: function (data) {
		            	if (data.d.results.length > 0)
		            	{			                
			                $.each(data.d.results,function(count,item){	 
			                	auth = item.Authors;
	                			if (auth != undefined){
			                		if(blogAuthors.indexOf(auth) === -1) {
			                			blogAuthors.push(auth);						     
								    }
								}       	                		
			                })   
			            }     			             
		                blogAuthors = blogAuthors.sort();
		                var authorSelect = document.getElementById("selAuthor");
	                    for(count=0;count<blogAuthors.length;count++)
				        {
				            authorSelect.add(new Option(blogAuthors[count], blogAuthors[count]), null);
				        }      
		            },
		            error: function (error) {
		                console.log(JSON.stringify(error));
		            }
		        });       
		                   
            },
            error: function (error) {
                console.log(JSON.stringify(error));
            }
        });  

        //getArchive();    
    });
    
    function buttonClick() {       
        getArchive();        
    }
    
    function getArchive() {
        
        var output = "";        
        var qryCategory = "";
    	var qryAuthor = "";    	
        var category= $('#selCategory').val();
        var author = $('#selAuthor').val(); 
        var division = $('#selDivision ').val();
        var year = $('#selYear').val();   
        var intYear = parseInt(year);     
       	beginDate = year + "-01-01T00%3a00%3a00";
	    endDate = year + "-12-31T23%3a59%3a59"; 	
	  	$(".blog-body").empty();
	  	if (intYear > 2021)
	  	{
	  		//Get data from Modren environment	
	  		if (category!= "All")  qryCategory = "(ListItemAllFields/HomeSiteBlogCategory eq '" + category+ "') and "; 
        	if (author != "All") qryAuthor = "(ListItemAllFields/HomeSiteBlogAuthor eq '" + author + "') and ";	 		        
	        $.ajax({
	            url: "https://fnma.sharepoint.com/sites/HomeSite-Blogs/_api/web/GetFolderByServerRelativeUrl('SitePages')/Files?$select=Name,Title,ServerRelativeUrl,ListItemAllFields&$expand=ListItemAllFields&$filter=" + qryCategory + qryAuthor + "(ListItemAllFields/HomeSiteBlogArticleDate ge datetime'" + beginDate + "') and (ListItemAllFields/HomeSiteBlogArticleDate le datetime'" + endDate + "') and (ListItemAllFields/PromotedState eq 2)&$orderby=ListItemAllFields/HomeSiteBlogArticleDate desc",
	            type: "GET",
	            headers: {
	                "accept": "application/json;odata=verbose",
	            },
	            success: function (data) {
					if (data.d.results.length > 0)
					{
					    var month = "";
					    $.each(data.d.results,function(count,item){	       
					        var startDate = new Date(item.ListItemAllFields.HomeSiteBlogArticleDate); 
					        var author = item.ListItemAllFields.HomeSiteBlogAuthor;
					        var currentMonth = startDate.toLocaleString('default', { month: 'long' });                  
					        if (month != currentMonth )
					        {
					            month = currentMonth ;  
					            output += "<div class='blog-item-header'>" + month + ' ' + startDate.getFullYear() + "</div>";                        
					        }
					        output += "<div class='blog-item'><div class='blog-date-time'>" + month + ' ' + + startDate.getDate() + ', ' + startDate.getFullYear() + "</div><div class='blog-author'>" + author + "</div> <a href='" + item.ServerRelativeUrl + "'>" + item.Title + "</a></div>";                                      
					    })
					    $(".blog-body").append(output);
					}
					else
					{
					    console.log("There are no items to show in this view.");
					}				                     
				},
			    error: function (error) {
			        console.log(JSON.stringify(error));
			    }
			});	        
        }
		
		if (intYear < 2022)
		{	
			if (category!= "All")  qryCategory = "(Category eq '" + category+ "') and "; 
        	if (author != "All") qryAuthor = "(Authors eq '" + author + "') and ";	 
			$.ajax({
			    url: "https://fnma.sharepoint.com/sites/fmHomeSite/execblog/_api/web/lists/getByTitle('Executive%20Blogs')/items?$select=Authors,ID,Title,ArticleStartDate,Category,OData__ModerationStatus&$orderby=ArticleStartDate desc&$filter=" + qryCategory + qryAuthor + "(OData__ModerationStatus eq 0) and(ArticleStartDate ge datetime'" + beginDate + "') and (ArticleStartDate le datetime'" + endDate + "')",
			    type: "GET",
			    headers: {
			        "accept": "application/json;odata=verbose",
			    },
			    success: function (data) {
			        if (data.d.results.length > 0)
			        {
			            var month = "";
			            $.each(data.d.results,function(count,item){	       
			                var startDate = new Date( item.ArticleStartDate); 
			                var author = item.Authors;			
			                var currentMonth = startDate.toLocaleString('en-US', { month: 'long' });                  
			                if (month != currentMonth )
			                {
			                    month = currentMonth ;  
			                    output += "<div class='blog-item-header'>" + month + ' ' + startDate.getFullYear() + "</div>";                        
			                }
			                output += "<div class='blog-item'><div class='blog-date-time'>" + month + ' ' + + startDate.getDate() + ', ' + startDate.getFullYear() + "</div><div class='blog-author'>" + author + "</div><div class='blog-title'></div><a href='/sites/fmhomesite/ExecutiveBlog/Lists/Community%20Discussion/Flat.aspx?RootFolder=%2Fsites%2Ffmhomesite%2FExecutiveBlog%2FLists%2FCommunity%20Discussion%2F" + item.Title + "&BlogId=" + item.ID + "'><b>" + item.Title + "</b></a></div></div>";
			            })
			            $(".blog-body").append(output);
			        }
			        else
			        {
			            console.log("There are no items to show in this view.");
			        }			                      
			    },
			    error: function (error) {
			        console.log(JSON.stringify(error));
			    }
			});	
		}
		
		   
	}
</script>
